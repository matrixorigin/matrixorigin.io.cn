# 使用 Cluster by 语句调优

`Cluster by` 是一种常用的性能调优技术，可以帮助优化查询的执行效率。本文将解释如何使用 `Cluster by` 进行性能调优。

## 什么是 `Cluster by`？

`Cluster by` 是一种用于优化表的物理排列方式的命令。在建表时使用 `Cluster by` 命令，对于无主键的表，可以按照指定的列对表进行物理排序，并将数据行重新排列成与该列的值的顺序相同的顺序。这种物理排序有助于提高查询性能。

以下是使用 `Cluster by` 的一些注意事项：

- `Cluster by` 不能和主键同时存在，否则会语法报错。

- `Cluster by` 只能在建表时指定，不支持动态创建。

下面是 `Cluster by` 的使用语法：

- 单列语法为：`create table() cluster by col;`  
- 多列语法为：`create table() cluster by (col1, col2);`  

## 如何使用 `Cluster by` 进行性能调优？

使用 `Cluster by` 进行性能调优的步骤如下：

1. 确定需要排序的列。

    首先需要确定需要排序的列。一般来说，可以选择那些经常用于过滤的列。对于具有时间序列特征的数据，时间列是常用的排序列。例如，如果有一个订单表，可以将订单按照时间进行排序。

2. 执行 `Cluster by` 命令。

    一旦确定了排序列，就可以在建表时执行 `Cluster by` 命令在建表时进行排序。

    下面我们来看一个示例：

    ```sql
    create table t1(a int, b int, c varchar(10)) cluster by(a,b,c);
    desc t1;
    +-------+-------------+------+------+---------+-------+---------+
    | Field | Type        | Null | Key  | Default | Extra | Comment |
    +-------+-------------+------+------+---------+-------+---------+
    | a     | INT(32)     | YES  |      | NULL    |       |         |
    | b     | INT(32)     | YES  |      | NULL    |       |         |
    | c     | VARCHAR(10) | YES  |      | NULL    |       |         |
    +-------+-------------+------+------+---------+-------+---------+
    3 rows in set (0.02 sec)
    ```

    在这个例子中，我们首先创建了一个名为 t1 的表。然后，使用 CLUSTER 命令按照 a，b，c 列对表进行物理排序。这样，所有的数据行将按照 a，b，c 列的值的顺序排列。

### 如何使 cluster by 发挥最好的效果？

- 一是尽可能将最常查询的列放在靠前的位置。

   对于 `Cluster by` 多多列的情况，第一列将取得最好的查询加速效果，因为第一列的数据分布是完全有序的。只有在第一列相同的情况下，剩下的数据会按照第二列进行排序。所以第二列的查询加速效果会弱于第一列。之后的列会依次递减。所以 `Cluster by` 通常不推荐指定太多列，一般 3-4 列即可。

- 二是将低基数的列放在靠前的位置。

   首先**基数**是指某一列上不同值的数量。例如性别，由于只有两个值，就是很典型的低基数列。例如身份证，一般情况下都不会重复，就是高基数列。如果将高基数列放在 `Cluster by` 第一列，整张表的数据分布已经完全在第一列上排好序了，导致后续的列不起作用。这种情况下建议使用 `Cluster by` 单列，或者将高基数列单独建索引，不要放在 `Cluster by` 中。

### 使用 `Cluster by` 需要注意的事项

- 对大表进行 `Cluster by` 可能需要很长时间

当对大表进行 `Cluster by` 时，可能需要很长时间才能完成。这是因为该操作需要重新组织表中的数据，重新排序并存储。因此，在执行 `Cluster by` 命令时，需要考虑表的大小和硬件配置。

- `Cluster by` 可能会影响插入和更新操作的性能

由于使用 `Cluster by` 会对表中的数据进行物理排序，因此插入和更新操作的性能可能会受到影响。当表中的数据按照某些列排序时，插入和更新操作可能需要移动许多行。因此，在使用 `Cluster by` 时，需要考虑这种影响。

- `Cluster by` 需要定期执行以保持性能

由于数据的增长和变化，表中的数据物理排序可能会失去效果。因此，需要定期执行 `Cluster by` 命令，以确保数据的物理排序仍然有效。

需要注意的是，`Cluster by` 命令的使用需要谨慎，建议在测试环境下先进行验证，以确保不会对表的数据产生负面影响。
